FROM mariadb:11.4.2

ARG BUILD_ENV_USERNAME
ARG BUILD_ENV_UID
ARG BUILD_ENV_GID 
ARG BUILD_ENV_GROUPNAME

ARG BUILD_ENV_MARIADB_USER
ARG BUILD_ENV_MARIADB_PASSWORD
ARG BUILD_ENV_MARIADB_ROOT_PASSWORD
ARG BUILD_ENV_MARIADB_DATABASE

###

ENV ENV_USERNAME=$BUILD_ENV_USERNAME
ENV ENV_USER_UID=$BUILD_ENV_UID
ENV ENV_USER_GID=$BUILD_ENV_GID 
ENV ENV_USER_GROUPNAME=$BUILD_ENV_GROUPNAME

ENV ENV_MARIADB_USER=$BUILD_ENV_MARIADB_USER
ENV ENV_MARIADB_PASSWORD=$BUILD_ENV_MARIADB_PASSWORD
ENV ENV_MARIADB_ROOT_PASSWORD=$BUILD_ENV_MARIADB_ROOT_PASSWORD
ENV ENV_MARIADB_DATABASE=$BUILD_ENV_MARIADB_DATABASE

RUN apt-get update && apt-get -y install vim
RUN apt-get -y install unzip

#RUN echo ${ENV_UID}

# Create the user
RUN echo groupadd --gid ${ENV_USER_GID} ${ENV_USER_GROUPNAME}
RUN groupadd --gid ${ENV_USER_GID} ${ENV_USER_GROUPNAME}
RUN echo useradd --uid ${ENV_USER_UID} --gid ${ENV_USER_GID} -m ${ENV_USERNAME}
RUN useradd --uid ${ENV_USER_UID} --gid ${ENV_USER_GID} -m ${ENV_USERNAME}

#RUN chown $USER_UID:$USER_GID /docker-entrypoint-initdb.d
RUN chown -R ${ENV_USER_UID}:${ENV_USER_GID} /var/lib/mysql

## this was just some test data
COPY world-db.zip /var/www/html/world-db.zip
RUN unzip -j /var/www/html/world-db.zip -d /docker-entrypoint-initdb.d

COPY init.sql /docker-entrypoint-initdb.d/init.sql

run echo ${ENV_USERNAME}

RUN chown -R ${ENV_USER_UID}:${ENV_USER_GID} /docker-entrypoint-initdb.d/

USER ${ENV_USERNAME}

env MARIADB_USER=${ENV_MARIADB_USER}
env MARIADB_PASSWORD=${ENV_MARIADB_PASSWORD}
env MARIADB_ROOT_PASSWORD=${ENV_MARIADB_ROOT_PASSWORD}
env MARIADB_DATABASE=${ENV_MARIADB_DATABASE}

EXPOSE 3306

CMD ["mariadbd"]
